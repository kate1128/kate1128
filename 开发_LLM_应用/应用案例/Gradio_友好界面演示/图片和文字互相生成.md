> å°†é€šè¿‡ç»“åˆ[å›¾ç‰‡ç”Ÿæˆæ–‡å­—](https://www.yuque.com/qiaokate/su87gb/sd01f47gvezh2sxp)ä»¥åŠ[æ–‡å­—ç”Ÿæˆå›¾åƒ](https://www.yuque.com/qiaokate/su87gb/ncyuys8aqi1rtilc)æ¥æ„å»ºä¸€ä¸ªç®€å•çš„æ¸¸æˆï¼Œå³å…ˆå¯¹å›¾åƒè¿›è¡Œæè¿°ï¼Œç„¶åé€šè¿‡æ¨¡å‹äº§ç”Ÿçš„æè¿°å†ç”Ÿæˆä¸€å¼ å›¾ç‰‡ã€‚
>
> éœ€è¦ HF_API_KEY
>
> éœ€è¦ HF_API_TTI_BASE
>

##  ç¯å¢ƒé…ç½®
åŠ è½½ HF API å’Œç›¸å…³çš„ Python APIã€‚

```python
import os
import io
from IPython.display import Image, display, HTML
from PIL import Image
import base64 

from dotenv import load_dotenv, find_dotenv
_ = load_dotenv(find_dotenv()) # read local .env file
hf_api_key = os.environ['HF_API_KEY']
```

##  æ ¸å¿ƒ API è°ƒç”¨
```python
import requests, json

# æˆ‘ä»¬å°†ä¼šé€šè¿‡è¿™ä¸ªå‡½æ•°æ—¢è°ƒç”¨å›¾åƒæè¿°æ¨¡å‹ï¼Œä¹Ÿè°ƒç”¨å›¾åƒç”Ÿæˆæ¨¡å‹
def get_completion(inputs, parameters=None, ENDPOINT_URL=""):
    headers = {
        "Authorization": f"Bearer {hf_api_key}",
        "Content-Type": "application/json"
    }   
    data = { "inputs": inputs }
    if parameters is not None:
        data.update({"parameters": parameters})
    response = requests.request("POST",
                                ENDPOINT_URL,
                                headers=headers,
                                data=json.dumps(data))
    return json.loads(response.content.decode("utf-8"))
```

```python
#å›¾åƒç”Ÿæˆæ¨¡å‹ API
TTI_ENDPOINT = os.environ['HF_API_TTI_BASE']
#å›¾åƒæè¿°æ¨¡å‹ API
ITT_ENDPOINT = os.environ['HF_API_ITT_BASE']
```

##  é€šè¿‡ `gr.Blocks()` æ„å»ºç®€å•çš„æ¸¸æˆ
å°†å‰å‡ è¯¾æˆ‘ä»¬ç”¨åˆ°çš„å›¾ç‰‡åˆ°base64ã€base64åˆ°å›¾ç‰‡ã€å›¾ç‰‡æè¿°ã€å›¾ç‰‡ç”Ÿæˆçš„å‡½æ•°æ•´ç†å¦‚ä¸‹ã€‚

```python
#Bringing the functions from lessons 3 and 4!
# PIL å›¾åƒè½¬æ¢ä¸º base64 å­—ç¬¦ä¸²
def image_to_base64_str(pil_image):
    byte_arr = io.BytesIO()
    pil_image.save(byte_arr, format='PNG')
    byte_arr = byte_arr.getvalue()
    return str(base64.b64encode(byte_arr).decode('utf-8'))

# base64 å­—ç¬¦ä¸²è½¬æ¢ä¸º PIL å›¾åƒ
def base64_to_pil(img_base64):
    base64_decoded = base64.b64decode(img_base64)
    byte_stream = io.BytesIO(base64_decoded)
    pil_image = Image.open(byte_stream)
    return pil_image

# å›¾åƒæè¿°
def captioner(image):
    base64_image = image_to_base64_str(image)
    result = get_completion(base64_image, None, ITT_ENDPOINT)
    return result[0]['generated_text']

# å›¾åƒç”Ÿæˆ
def generate(prompt):
    output = get_completion(prompt, None, TTI_ENDPOINT)
    result_image = base64_to_pil(output)
    return result_image
```

### ç¬¬ä¸€æ­¥ï¼šå›¾ç‰‡æè¿°
æˆ‘ä»¬å…ˆç”¨ Gradio å¤ç°å›¾åƒæè¿°çš„ GUIã€‚

```python
import gradio as gr 
with gr.Blocks() as demo:
    gr.Markdown("# æè¿°å’Œç”Ÿæˆæ¸¸æˆ")
    image_upload = gr.Image(label="ä½ çš„ç¬¬ä¸€å¼ å›¾ç‰‡",type="pil")
    btn_caption = gr.Button("ç”Ÿæˆæè¿°")
    caption = gr.Textbox(label="ç”Ÿæˆçš„æè¿°")

    btn_caption.click(fn=captioner, inputs=[image_upload], outputs=[caption])

gr.close_all()
demo.launch(share=True, server_port=int(os.environ['PORT1']))
```

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145091815-2ef588bb-2090-485f-877c-915bcbbace6f.png)

### ç¬¬äºŒæ­¥ï¼šæ·»åŠ å›¾åƒç”Ÿæˆ
ç„¶åï¼Œæˆ‘ä»¬å°†å›¾åƒç”ŸæˆåŠŸèƒ½åŠ å…¥åˆ°ä¹‹å‰åˆ¶ä½œçš„å›¾åƒæè¿° GUI ä¸­ã€‚

```python
with gr.Blocks() as demo:
    gr.Markdown("# æè¿°å’Œç”Ÿæˆæ¸¸æˆ ğŸ–ï¸")
    image_upload = gr.Image(label="ä½ çš„ç¬¬ä¸€å¼ å›¾ç‰‡",type="pil")
    btn_caption = gr.Button("ç”Ÿæˆæè¿°")
    caption = gr.Textbox(label="ç”Ÿæˆçš„æè¿°")
    btn_image = gr.Button("ç”Ÿæˆå›¾ç‰‡")
    image_output = gr.Image(label="ç”Ÿæˆçš„å›¾ç‰‡")
    btn_caption.click(fn=captioner, inputs=[image_upload], outputs=[caption])
    btn_image.click(fn=generate, inputs=[caption], outputs=[image_output])

gr.close_all()
demo.launch(share=True, server_port=int(os.environ['PORT2']))
```

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145092602-da06509f-f03a-4b34-b7ef-2e7ff97c4e87.png)

### åˆå¹¶å‰ä¸¤æ­¥ï¼šç›´æ¥è¾“å…¥å›¾ç‰‡å¾—åˆ°è¾“å‡ºå›¾ç‰‡
ä¸Šé¢æˆ‘ä»¬åˆ¶ä½œçš„ GUI éœ€è¦åˆ†åˆ«ç‚¹å‡»â€œæè¿°â€å’Œâ€œç”Ÿæˆâ€ä¸¤ä¸ªæŒ‰é”®ï¼Œç°åœ¨æˆ‘ä»¬å°†ä¸¤ä¸ªæŒ‰é”®ç»Ÿä¸€ä¸ºä¸€ä¸ªâ€œæè¿°å’Œç”Ÿæˆâ€æŒ‰é”®ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸€æ­¥å¾—åˆ°é‡æ–°ç”Ÿæˆçš„å›¾ç‰‡ã€‚

```python
def caption_and_generate(image):
    caption = captioner(image)
    image = generate(caption)
    return [caption, image]

with gr.Blocks() as demo:
    gr.Markdown("# Describe-and-Generate game ğŸ–ï¸")
    image_upload = gr.Image(label="Your first image",type="pil")
    btn_all = gr.Button("Caption and generate")
    caption = gr.Textbox(label="Generated caption")
    image_output = gr.Image(label="Generated Image")

    btn_all.click(fn=caption_and_generate, inputs=[image_upload], outputs=[caption, image_output])

gr.close_all()
demo.launch(share=True, server_port=int(os.environ['PORT3']))
```

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145092851-cdbf7bc7-73f2-4309-97bd-964e83c763b6.png)

```python
gr.close_all()
```

