> åˆ©ç”¨ Gradio åˆ¶ä½œä¸€ä¸ªç®€å•çš„å›¾åƒç”Ÿæˆåº”ç”¨ç¨‹åºã€‚
>
> HF_API_KEY
>

#  èƒŒæ™¯çŸ¥è¯†
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå°†ä½¿ç”¨ `diffusers` åº“ä¸­çš„ `Stable Diffusion `æ¨¡å‹ï¼ˆ`runwayml\stable-diffusion-v1-5`ï¼‰ã€‚æ¯”å¦‚ï¼Œè¾“å…¥â€œä¸€åªç«™åœ¨å¤ªç©ºé’ˆï¼ˆç¾å›½è¥¿é›…å›¾ä¸€å»ºç­‘ï¼‰ä¸Šçš„çº¢è‰²çš„é¸Ÿâ€ï¼Œå°†ä¼šå¾—åˆ°å³ä¾§çš„è¾“å‡ºå›¾ç‰‡ã€‚

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145060075-392a55e7-4941-4cfb-9be4-744e38d39708.png)

ä¸ä¹‹å‰å›¾ç‰‡æè¿°ä»»åŠ¡ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œå°†è¾“å…¥è¾“å‡ºé¢ å€’è¿‡æ¥ã€‚å…ˆè¾“å…¥å³ä¾§çš„æ–‡å­—ï¼Œç„¶åå¾—åˆ°å·¦ä¾§çš„å›¾ç‰‡ã€‚

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145060556-2b01e270-bae3-487f-a312-16c225022592.png)

#  ç¯å¢ƒé…ç½®
åŠ è½½ HF API å¯†é’¥å’Œç›¸å…³ Python åº“

```python
import os
import io
import IPython.display
from PIL import Image
import base64 
from dotenv import load_dotenv, find_dotenv
_ = load_dotenv(find_dotenv()) # read local .env file
hf_api_key = os.environ['HF_API_KEY']
```

# ä½¿ç”¨æ–‡æœ¬å›¾åƒç”Ÿæˆæ¨¡å‹
åœ¨è¿™é‡Œï¼Œå°†ä½¿ç”¨ `ğŸ§¨ diffusers` åº“è¿è¡Œ `runwayml/stable-diffusion-v1-5` ã€‚

## é€šè¿‡ HuggingFace API è°ƒç”¨
`Stable Diffusion` æ¨¡å‹ç›¸å¯¹è¾ƒå¤§ï¼Œæ¯”è¾ƒå ç”¨ç¡¬ä»¶èµ„æºã€‚å¦‚æœæœ¬åœ°æ²¡æœ‰è¶³å¤Ÿå¤§çš„æ˜¾å¡ï¼Œå¯ä»¥é€šè¿‡ `HuggingFace` çš„ `API` è¿›è¡Œè°ƒç”¨ã€‚

```python
import requests, json

#åŠ è½½æ–‡æœ¬å›¾åƒç”Ÿæˆæ¨¡å‹
def get_completion(inputs, parameters=None, ENDPOINT_URL=os.environ['HF_API_TTI_BASE']):
    headers = {
        "Authorization": f"Bearer {hf_api_key}",
        "Content-Type": "application/json"
    }   
    data = { "inputs": inputs }
    if parameters is not None:
        data.update({"parameters": parameters})
        # æ¨¡å‹çš„è°ƒç”¨å‡½æ•°
        response = requests.request("POST",
                                    ENDPOINT_URL,
                                    headers=headers,
                                    data=json.dumps(data))
    return json.loads(response.content.decode("utf-8"))
```

## æœ¬åœ°ä½¿ç”¨
å¦‚æœæœ¬åœ°çš„æ˜¾å¡èƒ½å¤Ÿæ”¯æŒ` Stable Diffusion `çš„è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ `diffusers` åº“è¿›è¡Œè°ƒç”¨å’Œè¿è¡Œã€‚

```python
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained("runwayml/stable-diffusion-v1-5") # åŠ è½½ stable-diffusion-v1-5 æ¨¡å‹

def get_completion(prompt):
    return pipeline(prompt).images[0]
```

## æµ‹è¯•è°ƒç”¨
ä¸‹é¢å¯¹ API çš„è°ƒç”¨è¿›è¡Œä¸€ä¸‹æµ‹è¯•ã€‚è¾“å…¥â€œ`a dog in a parkâ€`ï¼Œå¦‚æœæˆåŠŸçœ‹åˆ°è¿”å›çš„å›¾ç‰‡ï¼Œå°±è¯æ˜ API çš„è°ƒç”¨æˆåŠŸäº†ã€‚ æ³¨æ„è¿™ä¸ªæ¨¡å‹å¹¶ä¸æ”¯æŒä¸­æ–‡æ–‡æœ¬è¾“å…¥ã€‚

```python
prompt = "a dog in a park" # ä¸€åªåœ¨å…¬å›­é‡Œçš„ç‹— 

result = get_completion(prompt)
IPython.display.HTML(f'<img src="data:image/png;base64,{result}" />')
```

<details class="lake-collapse"><summary id="ud90c2766"><span class="ne-text" style="color: var(--jp-cell-prompt-not-active-font-color)">outputï¼š</span></summary><p id="u127eb3de" class="ne-p"><br></p></details>
# é€šè¿‡`gr.Interface()`æ„å»ºå›¾ç‰‡ç”Ÿæˆåº”ç”¨ç¨‹åº
## æ„å»ºä¸€ä¸ªåŸºæœ¬çš„å›¾åƒç”Ÿæˆåº”ç”¨ç¨‹åº
æƒ³è¦æŠŠä¸Šé¢çš„æ–‡æœ¬å›¾åƒç”Ÿæˆç®—æ³•åšæˆä¸€ä¸ª demo ç»™å…¶ä»–äººä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦ä¸ºç”¨æˆ·åˆ¶ä½œä¸€ä¸ªç®€å•å¥½ç”¨çš„ GUI ç•Œé¢ã€‚Gradioçš„å‡ºç°å¤§å¤§ç®€åŒ–äº†è¿™ä¸ªæ­¥éª¤ã€‚ä¸‹é¢ï¼Œå°†æ¼”ç¤ºæ„å»ºä¸€ä¸ªéå¸¸åŸºæœ¬çš„å›¾åƒç”Ÿæˆåº”ç”¨ç¨‹åºï¼Œå®ƒæœ‰æ–‡æœ¬è¾“å…¥æ¡†ã€å›¾åƒè¾“å‡ºæ¡†ç­‰ã€‚

```python
import gradio as gr 

# å°† base64çš„å­—ç¬¦ä¸²è½¬æ¢ä¸º PIL å›¾ç‰‡ç”¨äºæ˜¾ç¤º
def base64_to_pil(img_base64):
    base64_decoded = base64.b64decode(img_base64)
    byte_stream = io.BytesIO(base64_decoded)
    pil_image = Image.open(byte_stream)
    return pil_image

def generate(prompt):
    output = get_completion(prompt)
    result_image = base64_to_pil(output)
    return result_image

gr.close_all()
demo = gr.Interface(fn=generate,
                    inputs=[gr.Textbox(label="ä½ çš„æç¤º")],
                    outputs=[gr.Image(label="ç»“æœ")],
                    title="åŸºäº Stable Diffusion çš„å›¾ç‰‡ç”Ÿæˆ",
                    description="åŸºäº Stable Diffusion ç”Ÿæˆä»»æ„å›¾ç‰‡",
                    allow_flagging="never",
                    examples=["the spirit of a tamagotchi wandering in the city of Vienna","a mecha robot in a favela"])
# ä¾‹å­è§£é‡Šï¼šthe spirit of a tamagotchi wandering in the city of Vienna æ¸¸è¡åœ¨ç»´ä¹Ÿçº³åŸçš„å¡”é©¬æˆˆè’‚ä¹‹é­‚
# ä¾‹å­è§£é‡Šï¼ša mecha robot in a favela è´«æ°‘çªŸé‡Œçš„æœºæ¢°æœºå™¨äºº

demo.launch(share=True, server_port=int(os.environ['PORT1']))
```

è¿è¡Œä¸Šé¢çš„ä»£ç å¯ä»¥å¾—åˆ°å¦‚ä¸‹ GUI ç•Œé¢ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨çš„ Stable Diffusion æ¨¡å‹å¹¶ä¸æ”¯æŒä¸­æ–‡çš„ Prompt è¾“å…¥ã€‚è¯·ä½¿ç”¨è‹±æ–‡è¾“å…¥ Prommptï¼Œå¦åˆ™ä¸ä¼šå¾—åˆ°æƒ³è¦çš„å›¾ç‰‡ã€‚

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145062490-52304666-7b99-472b-8418-51d2fb76191d.png)

```python
demo.close()
```

## æ„å»ºä¸€ä¸ªé«˜çº§çš„å›¾ç‰‡ç”Ÿæˆç¨‹åº
é€šè¿‡æ·»åŠ  â€œè´Ÿé¢æç¤ºâ€ï¼Œâ€œæ¨ç†æ­¥é•¿â€ï¼Œâ€œæ–‡å­—çš„å¼•å¯¼ç¨‹åº¦â€ï¼Œâ€œå®½â€ï¼Œâ€œé«˜â€ ç­‰ï¼Œå¯ä»¥æ„å»ºä¸€ä¸ªå…·å¤‡é«˜çº§åŠŸèƒ½å’Œæ›´å¤šäº¤äº’åŠŸèƒ½çš„ GUIã€‚

```python
import gradio as gr 

#A helper function to convert the PIL image to base64 
# so you can send it to the API
def base64_to_pil(img_base64):
    base64_decoded = base64.b64decode(img_base64)
    byte_stream = io.BytesIO(base64_decoded)
    pil_image = Image.open(byte_stream)
    return pil_image

def generate(prompt, negative_prompt, steps, guidance, width, height):
    params = {
        "negative_prompt": negative_prompt,
        "num_inference_steps": steps,
        "guidance_scale": guidance,
        "width": width,
        "height": height
    }

    output = get_completion(prompt, params)
    pil_image = base64_to_pil(output)
    return pil_image

gr.close_all()
demo = gr.Interface(fn=generate,
                    inputs=[
                        gr.Textbox(label="ä½ çš„æç¤º"),
                        gr.Textbox(label="è´Ÿé¢æç¤º"), # ä½ æƒ³è¦é¿å…çš„å†…å®¹
                        gr.Slider(label="æ¨ç†æ­¥é•¿ï¼ˆInference Stepsï¼‰", minimum=1, maximum=100, value=25,
                                  info="å»å™ªå™¨å°†åˆ†å‡ æ­¥å¯¹å›¾åƒè¿›è¡Œå»å™ªï¼Ÿ"),
                        gr.Slider(label="æ–‡å­—çš„å¼•å¯¼ç¨‹åº¦", minimum=1, maximum=20, value=7, 
                                  info="æ§åˆ¶æ–‡å­—æç¤ºå¯¹ç»“æœçš„å½±å“ç¨‹åº¦"),
                        gr.Slider(label="å®½", minimum=64, maximum=512, step=64, value=512),
                        gr.Slider(label="é«˜", minimum=64, maximum=512, step=64, value=512),
                    ],
                    outputs=[gr.Image(label="Result")],
                    title="åŸºäº Stable Diffusion çš„å›¾ç‰‡ç”Ÿæˆ",
                    description="åŸºäº Stable Diffusion ç”Ÿæˆä»»æ„å›¾ç‰‡",
                    allow_flagging="never"
                   )

demo.launch(share=True, server_port=int(os.environ['PORT2']))
```

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145063282-acb077f1-45fb-45da-b194-37dd9a0c9e61.png)

```python
demo.close()
```

## ä½¿ç”¨ `gr.Blocks()` æ„å»ºæ›´é«˜çº§çš„åº”ç”¨ç¨‹åº
### ä½¿ç”¨è¡Œåˆ—æ§åˆ¶è®©æ’ç‰ˆæ›´å¥½çœ‹
ä½¿ç”¨ `gr.Blocks()` å¯ä»¥é€šè¿‡ `gr.Row()` å’Œ `gr.Column()` æŒ‡å®š GUI ä¸­ç»„ä»¶æ‰€åœ¨çš„å…·ä½“ä½ç½®ã€‚æ¯”å¦‚ä¸‹é¢ï¼Œå°†æç¤ºçš„è¾“å…¥æ”¾åœ¨äº†æœ€ä¸Šé¢çš„ä¸€æ’ï¼Œç„¶åå°†å…¶ä»–åŠŸèƒ½æ”¾åœ¨ä¸‹æ’çš„å·¦ä¾§ï¼Œå°†è¾“å‡ºçš„ç»“æœæ”¾åœ¨å³ä¾§ã€‚

```python
gr.close_all()
with gr.Blocks() as demo:
    gr.Markdown("# åŸºäº Stable Diffusion çš„å›¾åƒç”Ÿæˆ")
    prompt = gr.Textbox(label="ä½ çš„æç¤º")
    with gr.Row(): # è¡Œ
        with gr.Column(): # åˆ—
            negative_prompt = gr.Textbox(label="è´Ÿé¢æç¤º")
            steps = gr.Slider(label="æ¨ç†æ­¥é•¿ï¼ˆInference Stepsï¼‰", minimum=1, maximum=100, value=25,
                      info="å»å™ªå™¨å°†åˆ†å‡ æ­¥å¯¹å›¾åƒè¿›è¡Œå»å™ªï¼Ÿ")
            guidance = gr.Slider(label="æ–‡å­—çš„å¼•å¯¼ç¨‹åº¦", minimum=1, maximum=20, value=7,
                      info="æ§åˆ¶æ–‡å­—æç¤ºå¯¹ç»“æœçš„å½±å“ç¨‹åº¦")
            width = gr.Slider(label="å®½", minimum=64, maximum=512, step=64, value=512)
            height = gr.Slider(label="é«˜", minimum=64, maximum=512, step=64, value=512)
            btn = gr.Button("Submit")
        with gr.Column():
            output = gr.Image(label="Result")

    btn.click(fn=generate, inputs=[prompt,negative_prompt,steps,guidance,width,height], outputs=[output])
gr.close_all()
demo.launch(share=True, server_port=int(os.environ['PORT3']))
```

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145064432-4b4fcfd8-74aa-4bf5-87fb-3adb4f1b5c4a.png)

```python
demo.close()
```

### æ·»åŠ å¯ä»¥éšè—çš„é«˜çº§é€‰é¡¹
å› ä¸ºæœ‰çš„æ—¶å€™å¹¶ä¸éœ€è¦ä½¿ç”¨æŸäº›åŠŸèƒ½ï¼Œæ‰€ä»¥å¯ä»¥å…ˆå°†å®ƒä»¬éšè—èµ·æ¥ï¼Œåœ¨éœ€è¦çš„æ—¶å€™å†å±•å¼€å®ƒä»¬ã€‚è¿™æ ·ä¼šä½¿å¾—çš„ GUI æ›´åŠ ç®€æ´ã€‚

```python
with gr.Blocks() as demo:
    gr.Markdown("# åŸºäº Stable Diffusion çš„å›¾åƒç”Ÿæˆ")
    with gr.Row():
        with gr.Column(scale=4):
            prompt = gr.Textbox(label="ä½ çš„æç¤º") 
        with gr.Column(scale=1, min_width=50):
            btn = gr.Button("æäº¤") # æäº¤æŒ‰é’®åœ¨å¦å¤–ä¸€ä¾§
    with gr.Accordion("é«˜çº§é€‰é¡¹", open=False): # è®¾ç½®ä¸ºFalseå³é»˜è®¤éšè—é«˜çº§é€‰é¡¹ï¼Œè®¾ç½®ä¸ºTrueå³é»˜è®¤æ˜¾ç¤ºé«˜çº§é€‰é¡¹
            negative_prompt = gr.Textbox(label="è´Ÿé¢æç¤º")
            with gr.Row():
                with gr.Column():
                    steps = gr.Slider(label="æ¨ç†æ­¥é•¿ï¼ˆInference Stepsï¼‰", minimum=1, maximum=100, value=25,
                              info="å»å™ªå™¨å°†åˆ†å‡ æ­¥å¯¹å›¾åƒè¿›è¡Œå»å™ªï¼Ÿ")
                    guidance = gr.Slider(label="æ–‡å­—çš„å¼•å¯¼ç¨‹åº¦", minimum=1, maximum=20, value=7,
                              info="æ§åˆ¶æ–‡å­—æç¤ºå¯¹ç»“æœçš„å½±å“ç¨‹åº¦")
                with gr.Column():
                    width = gr.Slider(label="å®½", minimum=64, maximum=512, step=64, value=512)
                    height = gr.Slider(label="é«˜", minimum=64, maximum=512, step=64, value=512)
    output = gr.Image(label="ç»“æœ") 
            
    btn.click(fn=generate, inputs=[prompt,negative_prompt,steps,guidance,width,height], outputs=[output])

gr.close_all()
demo.launch(share=True, server_port=int(os.environ['PORT4']))
```

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145064409-bc5d01ba-a46d-4908-95c6-bb74bd921ac3.png)

å½“éœ€è¦ä½¿ç”¨è¿™äº›é«˜çº§é€‰é¡¹çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ç‚¹å‡»å³ä¾§çš„å°ä¸‰è§’å±•å¼€å®ƒä»¬ã€‚

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736145065246-e2bba908-04af-4b19-85cb-0006e54863e6.png)

```python
gr.close_all()
```

