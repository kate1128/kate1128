[推导式.pdf](https://www.yuque.com/attachments/yuque/0/2025/pdf/2639475/1753427301792-e5659b8b-a264-4683-9ecb-be274f42bbfc.pdf)

> 这应该算一些语法糖吧，搞计算用的
>

以下是 Python 推导式（Comprehensions）的全面总结，包含列表推导式、字典推导式、集合推导式及生成器表达式，通过 20+ 个典型场景的代码示例展示其强大功能：

## 一、列表推导式（List Comprehensions）
### 1. 基础形式
```python
# 生成 0-9 的平方列表
squares = [x**2 for x in range(10)]
# [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]
```

### 2. 条件过滤
```python
# 筛选偶数平方
even_squares = [x**2 for x in range(10) if x % 2 == 0]
# [0, 4, 16, 36, 64]
```

### 3. 多层循环
```python
# 矩阵展开（二维转一维）
matrix = [[1,2,3], [4,5,6], [7,8,9]]
flatten = [num for row in matrix for num in row]
# [1,2,3,4,5,6,7,8,9]
```

### 4. 条件表达式（三元运算）
```python
# 奇偶分类标记
labels = ["Even" if x%2==0 else "Odd" for x in range(5)]
# ['Even', 'Odd', 'Even', 'Odd', 'Even']
```

### 5. 嵌套推导式
```python
# 生成乘法表
mul_table = [[i*j for j in range(1,6)] for i in range(1,6)]
# [[1,2,3,4,5], [2,4,6,8,10], ..., [5,10,15,20,25]]
```

### 6. 海象运算符（Walrus Operator，Python 3.8+）
```python
# 计算并保留中间值
results = [y for x in [4,2,6,1] if (y := x**2) > 10]
# [16, 36]
```

## 二、字典推导式（Dict Comprehensions）
### 1. 键值转换
```python
# 创建字母位置映射
letter_pos = {char: idx for idx, char in enumerate("abcde", 1)}
# {'a':1, 'b':2, 'c':3, 'd':4, 'e':5}
```

### 2. 条件过滤
```python
# 筛选值大于3的项
scores = {'Alice':85, 'Bob':92, 'Charlie':78}
good_scores = {k:v for k,v in scores.items() if v > 80}
# {'Alice':85, 'Bob':92}
```

### 3. 键值反转
```python
# 反转键值（需确保值唯一）
rev_dict = {v:k for k,v in {'a':1, 'b':2}.items()}
# {1:'a', 2:'b'}
```

### 4. 多重数据源
```python
# 合并两个列表创建字典
keys = ['a', 'b', 'c']
values = [1, 2, 3]
combined = {k:v for k,v in zip(keys, values)}
# {'a':1, 'b':2, 'c':3}
```

### 5. 复杂键值计算
```python
# 生成ASCII码映射（字符→码值）
ascii_map = {chr(x):x for x in range(65,70)}
# {'A':65, 'B':66, 'C':67, 'D':68, 'E':69}
```

## 三、集合推导式（Set Comprehensions）
### 1. 去重处理
```python
# 统计唯一单词长度
words = ["apple", "banana", "cherry", "apple"]
unique_lens = {len(word) for word in words}
# {5,6}
```

### 2. 复杂条件
```python
# 找出既是平方数又是立方数的数
special_nums = {x for x in range(1000) 
               if int(x**0.5)**2 == x and int(x**(1/3))**3 == x}
# {0,1,64,729}
```

## 四、生成器表达式（Generator Expressions）
### 1. 惰性求值
```python
# 处理大文件（逐行处理）
lines = (line.strip() for line in open('data.txt'))
uppercase = (line.upper() for line in lines if line)

# 实际执行时才处理文件
for processed_line in uppercase:
    print(processed_line)
```

### 2. 链式操作
```python
# 多步骤数据处理管道
nums = (x**2 for x in range(1000000))
filtered = (x for x in nums if x % 3 == 0)
result = sum(x//2 for x in filtered)  # 内存高效
```

## 五、高级技巧与场景
### 1. 异常处理
```python
# 安全转换数值类型
str_list = ["12", "3.14", "NaN", "42"]
safe_ints = [int(x) for x in str_list if x.isdigit()]
# [12,42]
```

### 2. 函数组合
```python
# 配合map/filter使用
from math import sqrt
nums = [2, -4, 9, -16]
abs_roots = [sqrt(x) for x in map(abs, nums)]
# [1.414, 2.0, 3.0, 4.0]
```

### 3. 动态嵌套结构
```python
# 生成树状结构
tree = {depth: [0]*depth for depth in range(1,5)}
# {1:[0], 2:[0,0], 3:[0,0,0], 4:[0,0,0,0]}
```

### 4. 矩阵运算
```python
# 矩阵转置
matrix = [[1,2,3], [4,5,6]]
transpose = [[row[i] for row in matrix] for i in range(3)]
# [[1,4], [2,5], [3,6]]
```

### 5. 类型转换
```python
# 字符串→ASCII码列表
ascii_codes = [ord(c) for c in "Python"]
# [80, 121, 116, 104, 111, 110]
```

## 六、性能对比
### 1. 列表生成效率
```python
# 传统循环 vs 推导式
def traditional_loop(n):
    result = []
    for i in range(n):
        if i % 2 ==0:
            result.append(i**2)
    return result

def comprehension(n):
    return [i**2 for i in range(n) if i%2==0]

# 测试 n=1e6 时推导式快约 30%
```

### 2. 内存效率
```python
# 生成器节省内存
import sys

list_size = sys.getsizeof([x for x in range(100000)])
gen_size = sys.getsizeof((x for x in range(100000)))

print(f"List: {list_size} bytes")  # ~900KB
print(f"Generator: {gen_size} bytes")  # ~128 bytes
```

---

## 七、最佳实践
1. **可读性优先**：当推导式超过 2 层循环或 3 个条件时，改用传统循环

```python
# 不推荐复杂推导式
result = [[x*y for y in range(10) if y%2==0] for x in range(5) if x>1]

# 推荐拆分
result = []
for x in range(5):
    if x >1:
        row = [x*y for y in range(10) if y%2==0]
        result.append(row)
```

2. **避免副作用**：推导式应专注于数据转换，避免修改外部状态

```python
# 错误示例（副作用）
counter = 0
bad_example = [counter +=1 for _ in range(5)]  # 语法错误

# 正确做法
counter = sum(1 for _ in range(5))
```

3. **命名表达式**：复杂计算使用中间变量

```python
# 使用海象运算符提高可读性
data = ["apple123", "banana", "cherry45"]
cleaned = [ (name := item[:-3]) if item[-3:].isdigit() else item 
           for item in data ]
# ['apple', 'banana', 'cherry']
```

通过掌握这些推导式技巧，您可以用更简洁高效的 Pythonic 方式处理数据转换、过滤和聚合任务，同时保持代码的可读性和性能。

