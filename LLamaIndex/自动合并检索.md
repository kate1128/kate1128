在本课程中，将探索一种高级的检索聚合（RAG）技术——自动合并检索。这种方法解决了使用传统RAG时遇到的一个关键问题：当检索信息块以填充语言模型（LLM）上下文时，如果这些块过于碎片化，将会影响上下文的连贯性，特别是当这些块的大小较小时。为了克服这一挑战，将采用一种自动合并启发式方法，该方法通过将较小的信息块合并到更大的父块中，从而保证了上下文的连贯性。接下来，将详细介绍如何实现这一技术，并通过实际案例来演示其应用。

##  自动合并检索的设置
将所有文档合并成一个大的文档对象，以便进行自动合并检索。

```python
from llama_index import Document

# 将所有文档文本合并成一个大文档
document = Document(text="\n\n".join([doc.text for doc in documents]))
```

将中文标点符号替换成英文标点符号，方便后续处理

```python
# 将中文标点符号替换成英文标点符号，方便后续处理
# 如果是英文文档，可以跳过这一步
# 不处理的话，会导致无法正确切分中文句子，会影响后续sentence_window的大小，导致输入长度大于gpt-3.5-turbo的最大限制
document.text=document.text.replace('。','. ')
document.text=document.text.replace('！','! ')
document.text=document.text.replace('？','? ')
```

现在，将创建一个层次结构节点解析器。这个解析器将帮助根据文档内容创建一个层次结构，以便于后续的自动合并操作。

```python
from llama_index.node_parser import HierarchicalNodeParser

# 使用默认设置创建层次结构节点解析器
node_parser = HierarchicalNodeParser.from_defaults(
    chunk_sizes=[2048, 512, 128]
)
```

通过节点解析器，得到了文档中的所有节点。

```python
# 从文档中获取节点
nodes = node_parser.get_nodes_from_documents([document])
```

为了展示如何具体操作，将取出一些叶节点并查看它们的内容。叶节点是层次结构中最小的块，它们将直接参与到后续的合并过程中。

```python
from llama_index.node_parser import get_leaf_nodes

# 获取叶节点并打印其中一个的文本作为示例
leaf_nodes = get_leaf_nodes(nodes)
print(leaf_nodes[30].text)
```

<details class="lake-collapse"><summary id="u1346c8c5"><span class="ne-text">output：</span></summary><pre data-language="json" id="rGKEp" class="ne-codeblock language-json"><code>⼈⼯智能⼯具
与司法部门的⼈类法官相辅相成，提供客观、⼀致的风险评估[13].</code></pre></details>
也可以查看这些叶节点的父节点。父节点包含了它的所有子节点的内容，这对于理解自动合并的过程非常重要。

```python
# 根据ID获取节点，并打印一个叶节点的父节点文本作为示例
nodes_by_id = {node.node_id: node for node in nodes}

parent_node = nodes_by_id[leaf_nodes[30].parent_node.node_id]
print(parent_node.text)
```

<details class="lake-collapse"><summary id="u0e828113"><span class="ne-text">output：</span></summary><pre data-language="json" id="Cghag" class="ne-codeblock language-json"><code>⼈⼯智能为地⽅政府服务带来技术突破. ⼈⼯智能代理协助城市规划者基于⽬标导向的蒙特卡罗树搜索进⾏场景规划. ⽬标推理⼈⼯智能代理提供最佳的⼟
地利⽤解决⽅案，帮助制定民主的城市⼟地利⽤规划. ⼈⼯智能利⽤在线数据来监控和修改环境威胁政策. 在2019 年⽔危机期间，潜在狄利克雷分配⽅
法确定了Twitter (X) 中讨论最多的主题，这是⼀种朴素的推⽂分类⽅法，对⼲旱的影响和原因、政府响应和潜在解决⽅案等主题进⾏了分类. ⼈⼯智能⼯具
与司法部门的⼈类法官相辅相成，提供客观、⼀致的风险评估[13].</code></pre></details>
### 构建索引
构建索引并定义检索器，以便运行查询引擎并评估自动合并检索的效果。继续构建的自动合并检索系统，需要使用 OpenAI 的语言模型和一些自定义组件来构建索引，这些组件将支持的自动合并逻辑。

1. 首先，将初始化一个 OpenAI 的语言模型，这里选择使用 GPT-3.5 Turbo ，这是一个强大的模型，适用于各种NLP任务。

```python
from llama_index.llms import OpenAI

# 使用OpenAI的GPT-3.5 Turbo模型
llm = OpenAI(model="gpt-3.5-turbo", temperature=0.1)
```

接下来，将创建一个服务上下文对象。这个对象将包含所需的所有服务，例如嵌入模型和节点解析器，以便的系统能够正确地执行自动合并检索。

```python
from llama_index import ServiceContext

# 创建服务上下文，包括LLM模型和节点解析器
auto_merging_context = ServiceContext.from_defaults(
    llm=llm,
    embed_model="local:BAAI/bge-small-zh-v1.5",
    node_parser=node_parser,
)
```

现在，需要将的文档节点存储在一个索引中。这个索引将支持快速检索操作，并允许根据需要动态合并文档节点。

```python
from llama_index import VectorStoreIndex, StorageContext

# 创建存储上下文并添加文档节点
storage_context = StorageContext.from_defaults()
storage_context.docstore.add_documents(nodes)

# 创建自动合并索引
automerging_index = VectorStoreIndex(
    leaf_nodes, storage_context=storage_context, service_context=auto_merging_context
)

# 持久化索引以便未来使用
automerging_index.storage_context.persist(persist_dir="./merging_index")
```

为了确保的系统能够在需要时重新加载索引，还提供了一个可选的代码块，用于检查索引文件是否存在，并根据需要加载或重新构建它。

```python
# 可选代码块：检查索引文件是否存在，如果不存在则重建
import os
from llama_index import VectorStoreIndex, StorageContext, load_index_from_storage
from llama_index import load_index_from_storage

if not os.path.exists("./merging_index"):
    storage_context = StorageContext.from_defaults()
    storage_context.docstore.add_documents(nodes)

    automerging_index = VectorStoreIndex(
            leaf_nodes,
            storage_context=storage_context,
            service_context=auto_merging_context
        )

    automerging_index.storage_context.persist(persist_dir="./merging_index")
else:
    automerging_index = load_index_from_storage(
        StorageContext.from_defaults(persist_dir="./merging_index"),
        service_context=auto_merging_context
    )
```

### 定义检索器并运行查询引擎
接下来，将定义检索器并运行查询引擎。这个过程中，将设置一个自动合并检索器，这个检索器将控制文档节点的合并逻辑，以确保检索到的上下文是连贯的。

```python
from llama_index.indices.postprocessor import SentenceTransformerRerank
from llama_index.retrievers import AutoMergingRetriever
from llama_index.query_engine import RetrieverQueryEngine

# 将自动合并索引转换为检索器
automerging_retriever = automerging_index.as_retriever(
    similarity_top_k=12
)

# 定义自动合并检索器
retriever = AutoMergingRetriever(
    automerging_retriever, 
    automerging_index.storage_context, 
    verbose=True
)

# 定义重新排名模块
rerank = SentenceTransformerRerank(top_n=6, model="BAAI/bge-reranker-base")

# 创建自动合并检索查询引擎
auto_merging_engine = RetrieverQueryEngine.from_args(
    automerging_retriever, node_postprocessors=[rerank]
)
```

为了测试的自动合并检索系统，将使用一个示例查询：“AI对人类的威胁有哪些？”并展示检索到的响应。

```python
# 使用查询引擎执行查询
auto_merging_response = auto_merging_engine.query(
    "AI对人类的威胁有哪些？"
)
```

可以使用提供的工具函数来美观地展示检索到的响应。

```python
from llama_index.response.notebook_utils import display_response

# 显示查询响应
display_response(auto_merging_response)
```

`**Final Response:**` AI对人类的威胁包括：AI会遵循科技发展的加速度理论、AI可能会有自我改造创新的能力、AI进步的速度远远超过人类、人类会有被灭绝的危机。

## 整合所有步骤
将整合上述所有步骤，并通过 TruLens 对的自动合并检索系统进行评估，以验证其性能。

为了将自动合并检索的各个部分整合在一起并进行评估，将定义两个高级函数：`build_automerging_index` 和 `get_automerging_query_engine` 。这些函数将帮助构建索引并初始化查询引擎，使能够以更简洁的方式测试和评估不同的配置。

首先，定义 `build_automerging_index` 函数，该函数负责构建自动合并索引。这个函数将接受文档、语言模型、嵌入模型和保存目录作为参数，并构建一个包含所有文档节点的索引。

接下来，定义 `get_automerging_query_engine` 函数，该函数负责从自动合并索引中创建查询引擎。它设置了检索器，使之能够根据相似性的 top K 值进行检索，并应用重新排序逻辑来优化检索结果。

```python
import os

from llama_index import (
    ServiceContext,
    StorageContext,
    VectorStoreIndex,
    load_index_from_storage,
)
from llama_index.node_parser import HierarchicalNodeParser
from llama_index.node_parser import get_leaf_nodes
from llama_index import StorageContext, load_index_from_storage
from llama_index.retrievers import AutoMergingRetriever
from llama_index.indices.postprocessor import SentenceTransformerRerank
from llama_index.query_engine import RetrieverQueryEngine


# 定义构建自动合并索引的函数
def build_automerging_index(
    documents,
    llm,
    embed_model="local:BAAI/bge-small-zh-v1.5",
    save_dir="merging_index",
    chunk_sizes=None,
):
    chunk_sizes = chunk_sizes or [2048, 512, 128]
    node_parser = HierarchicalNodeParser.from_defaults(chunk_sizes=chunk_sizes)
    nodes = node_parser.get_nodes_from_documents(documents)
    leaf_nodes = get_leaf_nodes(nodes)
    merging_context = ServiceContext.from_defaults(
        llm=llm,
        embed_model=embed_model,
    )
    storage_context = StorageContext.from_defaults()
    storage_context.docstore.add_documents(nodes)

    if not os.path.exists(save_dir):
        automerging_index = VectorStoreIndex(
            leaf_nodes, storage_context=storage_context, service_context=merging_context
        )
        automerging_index.storage_context.persist(persist_dir=save_dir)
    else:
        automerging_index = load_index_from_storage(
            StorageContext.from_defaults(persist_dir=save_dir),
            service_context=merging_context,
        )
    return automerging_index


# 定义获取自动合并查询引擎的函数
def get_automerging_query_engine(
    automerging_index,
    similarity_top_k=12,
    rerank_top_n=6,
):
    base_retriever = automerging_index.as_retriever(similarity_top_k=similarity_top_k)
    retriever = AutoMergingRetriever(
        base_retriever, automerging_index.storage_context, verbose=True
    )
    rerank = SentenceTransformerRerank(
        top_n=rerank_top_n, model="BAAI/bge-reranker-base"
    )
    auto_merging_engine = RetrieverQueryEngine.from_args(
        retriever, node_postprocessors=[rerank]
    )
    return auto_merging_engine
```

使用这两个函数，可以方便地构建索引和查询引擎，并通过不同的参数配置来测试自动合并检索的效果。下面是如何使用这些函数的示例：

```python
from llama_index.llms import OpenAI

# 构建自动合并索引
index = build_automerging_index(
    [document],
    llm=OpenAI(model="gpt-3.5-turbo", temperature=0.1),
    save_dir="./merging_index",
)
```

获取自动合并查询引擎

```python
# 获取自动合并查询引擎
query_engine = get_automerging_query_engine(index, similarity_top_k=6)
```

## TruLens评估
在构建了自动合并索引和查询引擎后，将使用 TruLens 来评估自动合并检索器的性能。 TruLens 是一个用于评估 AI 模型的工具，可以提供详细的性能指标。将首先重置 TruLens 数据库，然后进行评估。

```python
from trulens_eval import Tru

# 重置TruLens数据库
Tru().reset_database()
```

将分别评估两层和三层自动合并结构的性能，并使用 TruLens 来记录和展示评估结果。这将帮助理解不同层次结构配置对性能的影响，并为提供优化自动合并检索策略的洞见。

在进行 TruLens 评估之前，需要为两种不同的层次结构设置自动合并索引和查询引擎。这两种结构分别是两层结构和三层结构。通过比较这两种结构的性能，可以更好地理解层次结构深度对自动合并检索效果的影响。

### 两层结构的索引构建
首先，将构建一个只有两层的自动合并索引。这种结构简化了创建索引的过程，并减少了检索步骤中所需的工作量。

```python
# 构建具有两层结构的自动合并索引
auto_merging_index_0 = build_automerging_index(
    documents,
    llm=OpenAI(model="gpt-3.5-turbo", temperature=0.1),
    embed_model="local:BAAI/bge-small-zh-v1.5",
    save_dir="merging_index_0",
    chunk_sizes=[2048,512],
)
```

接着，为这个两层结构的自动合并索引设置查询引擎，并保持与之前相同的 top K 和重新排名步骤。

```python
# 获取两层结构的自动合并查询引擎
auto_merging_engine_0 = get_automerging_query_engine(
    auto_merging_index_0,
    similarity_top_k=12,
    rerank_top_n=6,
)
```

为了进行 TruLens 评估，需要定义一个 TruLens 录音器，它将记录查询引擎的响应和评估结果。

```python
from utils import get_prebuilt_trulens_recorder

# 使用TruLens记录器准备评估
tru_recorder = get_prebuilt_trulens_recorder(
    auto_merging_engine_0,
    app_id ='app_0'  # 设置应用ID
)
```

然后，从预先准备好的问题文件中加载评估问题，并定义一个运行评估的函数。这个函数将遍历所有评估问题，并记录每个问题的查询结果。

```python
# 加载评估问题
eval_questions = []
with open('./data/generated_questions.txt', 'r', encoding="utf8") as file:
    for line in file:
        item = line.strip()  # 移除换行符
        eval_questions.append(item)
```

最后，使用上面定义的函数运行评估，并通过 TruLens 获取并展示排行榜。

```python
import time
# 定义运行评估的函数
def run_evals(eval_questions, tru_recorder, query_engine):
    for question in eval_questions:
        with tru_recorder as recording:
            response = query_engine.query(question)
            time.sleep(2)
            # 此处运行评估并记录结果
```

对两层结构进行评估

```python
# 对两层结构进行评估
run_evals(eval_questions, tru_recorder, auto_merging_engine_0)
```

<details class="lake-collapse"><summary id="ud90c2766"><span class="ne-text">output：</span></summary><pre data-language="json" id="iOXbm" class="ne-codeblock language-json"><code>&gt; Merging 3 nodes into parent node.
&gt; Parent node id: d33cd5ff-82dc-4ba8-a6d7-c3b77f35315b.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 3/13
本体论将知识表示为⼀个领域内的⼀
组概...

&gt; Merging 4 nodes into parent node.
&gt; Parent node id: 4a656a65-c52b-410b-8152-1545952c47ad.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 6/13智能是否可以使⽤⾼级符号表达，如词和想法...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: cc7c42fb-22be-4ba5-b8c4-281f4b8b6236.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 4/13
Kismet，⼀个具有表情等社交能⼒
...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: fded6622-1120-4fae-8784-fe5052059204.
&gt; Parent node text: 2017年6⽉份马云在美国底特律举⾏“链接世界”（Gateway 17）产业⼤会，会上提出⼈⼯智能可能导致第三次世界⼤战，因为前两次产业⾰命都导致两次⼤
战，战争原因并⾮这些创新发明本⾝，⽽是发...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: d6a24814-902b-4670-9bad-70f7a5be9f03.
&gt; Parent node text: The Behavioral and Brain Sciences, vol. 3, 1980）
关于强⼈⼯智能的争论，不同于更⼴义的⼀元论和⼆元论的争论。其争论要点是：如果⼀台机器的唯⼀⼯作原...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: fded6622-1120-4fae-8784-fe5052059204.
&gt; Parent node text: 2017年6⽉份马云在美国底特律举⾏“链接世界”（Gateway 17）产业⼤会，会上提出⼈⼯智能可能导致第三次世界⼤战，因为前两次产业⾰命都导致两次⼤
战，战争原因并⾮这些创新发明本⾝，⽽是发...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: 8dd15e3b-2094-4fb8-9a72-c621ee342481.
&gt; Parent node text: 其它关于 动物 或其它⼈造系统的智能也普遍被认为是⼈⼯智能相关的研究课题。
⼈⼯智能⽬前在 电脑 领域内，得到了愈加⼴泛的发挥。并在 机器⼈ 、经济政治决策、 控制系统 、仿真系统 中得到应⽤。...

&gt; Merging 4 nodes into parent node.
&gt; Parent node id: d33cd5ff-82dc-4ba8-a6d7-c3b77f35315b.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 3/13
本体论将知识表示为⼀个领域内的⼀
组概...

&gt; Merging 4 nodes into parent node.
&gt; Parent node id: e72ee5b0-427f-475e-8142-69703f6d2c05.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 5/133. 把AI当作同事，形成协同合作的团队...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: 12551bc8-6bdd-4504-b2e5-2b572d628504.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 2/13“⼈⼯智能”的各地常⽤名称
中国⼤陆⼈⼯...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: d6a24814-902b-4670-9bad-70f7a5be9f03.
&gt; Parent node text: The Behavioral and Brain Sciences, vol. 3, 1980）
关于强⼈⼯智能的争论，不同于更⼴义的⼀元论和⼆元论的争论。其争论要点是：如果⼀台机器的唯⼀⼯作原...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: d05268fc-e638-4cf4-aa06-bb827ff13a27.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 8/13东映特摄剧《 假⾯骑⼠Z ERO-ONE...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: cc7c42fb-22be-4ba5-b8c4-281f4b8b6236.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 4/13
Kismet，⼀个具有表情等社交能⼒
...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: 8dd15e3b-2094-4fb8-9a72-c621ee342481.
&gt; Parent node text: 其它关于 动物 或其它⼈造系统的智能也普遍被认为是⼈⼯智能相关的研究课题。
⼈⼯智能⽬前在 电脑 领域内，得到了愈加⼴泛的发挥。并在 机器⼈ 、经济政治决策、 控制系统 、仿真系统 中得到应⽤。...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: d6a24814-902b-4670-9bad-70f7a5be9f03.
&gt; Parent node text: The Behavioral and Brain Sciences, vol. 3, 1980）
关于强⼈⼯智能的争论，不同于更⼴义的⼀元论和⼆元论的争论。其争论要点是：如果⼀台机器的唯⼀⼯作原...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: 12551bc8-6bdd-4504-b2e5-2b572d628504.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 2/13“⼈⼯智能”的各地常⽤名称
中国⼤陆⼈⼯...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: 12551bc8-6bdd-4504-b2e5-2b572d628504.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 2/13“⼈⼯智能”的各地常⽤名称
中国⼤陆⼈⼯...

&gt; Merging 4 nodes into parent node.
&gt; Parent node id: e72ee5b0-427f-475e-8142-69703f6d2c05.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 5/133. 把AI当作同事，形成协同合作的团队...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: d6a24814-902b-4670-9bad-70f7a5be9f03.
&gt; Parent node text: The Behavioral and Brain Sciences, vol. 3, 1980）
关于强⼈⼯智能的争论，不同于更⼴义的⼀元论和⼆元论的争论。其争论要点是：如果⼀台机器的唯⼀⼯作原...

&gt; Merging 4 nodes into parent node.
&gt; Parent node id: 12551bc8-6bdd-4504-b2e5-2b572d628504.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 2/13“⼈⼯智能”的各地常⽤名称
中国⼤陆⼈⼯...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: 4a656a65-c52b-410b-8152-1545952c47ad.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 6/13智能是否可以使⽤⾼级符号表达，如词和想法...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: 8dd15e3b-2094-4fb8-9a72-c621ee342481.
&gt; Parent node text: 其它关于 动物 或其它⼈造系统的智能也普遍被认为是⼈⼯智能相关的研究课题。
⼈⼯智能⽬前在 电脑 领域内，得到了愈加⼴泛的发挥。并在 机器⼈ 、经济政治决策、 控制系统 、仿真系统 中得到应⽤。...

&gt; Merging 4 nodes into parent node.
&gt; Parent node id: 12551bc8-6bdd-4504-b2e5-2b572d628504.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 2/13“⼈⼯智能”的各地常⽤名称
中国⼤陆⼈⼯...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: fded6622-1120-4fae-8784-fe5052059204.
&gt; Parent node text: 2017年6⽉份马云在美国底特律举⾏“链接世界”（Gateway 17）产业⼤会，会上提出⼈⼯智能可能导致第三次世界⼤战，因为前两次产业⾰命都导致两次⼤
战，战争原因并⾮这些创新发明本⾝，⽽是发...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: 8dd15e3b-2094-4fb8-9a72-c621ee342481.
&gt; Parent node text: 其它关于 动物 或其它⼈造系统的智能也普遍被认为是⼈⼯智能相关的研究课题。
⼈⼯智能⽬前在 电脑 领域内，得到了愈加⼴泛的发挥。并在 机器⼈ 、经济政治决策、 控制系统 、仿真系统 中得到应⽤。...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: fded6622-1120-4fae-8784-fe5052059204.
&gt; Parent node text: 2017年6⽉份马云在美国底特律举⾏“链接世界”（Gateway 17）产业⼤会，会上提出⼈⼯智能可能导致第三次世界⼤战，因为前两次产业⾰命都导致两次⼤
战，战争原因并⾮这些创新发明本⾝，⽽是发...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: 12551bc8-6bdd-4504-b2e5-2b572d628504.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 2/13“⼈⼯智能”的各地常⽤名称
中国⼤陆⼈⼯...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: d6a24814-902b-4670-9bad-70f7a5be9f03.
&gt; Parent node text: The Behavioral and Brain Sciences, vol. 3, 1980）
关于强⼈⼯智能的争论，不同于更⼴义的⼀元论和⼆元论的争论。其争论要点是：如果⼀台机器的唯⼀⼯作原...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: fded6622-1120-4fae-8784-fe5052059204.
&gt; Parent node text: 2017年6⽉份马云在美国底特律举⾏“链接世界”（Gateway 17）产业⼤会，会上提出⼈⼯智能可能导致第三次世界⼤战，因为前两次产业⾰命都导致两次⼤
战，战争原因并⾮这些创新发明本⾝，⽽是发...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: d6a24814-902b-4670-9bad-70f7a5be9f03.
&gt; Parent node text: The Behavioral and Brain Sciences, vol. 3, 1980）
关于强⼈⼯智能的争论，不同于更⼴义的⼀元论和⼆元论的争论。其争论要点是：如果⼀台机器的唯⼀⼯作原...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: 4a656a65-c52b-410b-8152-1545952c47ad.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 6/13智能是否可以使⽤⾼级符号表达，如词和想法...

&gt; Merging 5 nodes into parent node.
&gt; Parent node id: 4a656a65-c52b-410b-8152-1545952c47ad.
&gt; Parent node text: 2/2/24, 2:43 PM ⼈⼯智能  - 维基百科，⾃由的百科全书
https://zh.wikipedia.org/wiki/ ⼈⼯智能 6/13智能是否可以使⽤⾼级符号表达，如词和想法...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: 54c0b611-afdd-455f-ad8d-323bdac93a92.
&gt; Parent node text: 这和其他的⼦符号⽅法，如模糊控制和进化计算，都属于计算智能学科研
究范畴[59]。
1990年代，⼈⼯智能研究发展出复杂的数学⼯具来解决特定的分⽀问题。这些⼯具是真正的科学⽅法，即这些⽅法的结果...

&gt; Merging 1 nodes into parent node.
&gt; Parent node id: 76fbc499-4fc9-41b4-b14e-090faa72952d.
&gt; Parent node text: ⽆论哪种学习⽅法都会进⾏误差分析，从⽽知道所提的⽅法在理论上是否误差有上限。
⾃然语⾔处理探讨如何处理及运⽤⾃然语⾔，⾃然语⾔认知则是指让电脑“懂”⼈类的语⾔。⾃然语⾔⽣成系统把计算机数据转化为...</code></pre></details>
获取并显示排行榜

```python
from trulens_eval import Tru

# 获取并显示排行榜
Tru().get_leaderboard(app_ids=[])
```

运行TruLens仪表板查看详细评估结果

```python
# 运行TruLens仪表板查看详细评估结果
Tru().run_dashboard()
```

### 三层结构的索引构建
接下来，将尝试一个更复杂的自动合并索引构建方法，包含三层结构，并可能提高检索的质量。

```python
# 构建具有三层结构的自动合并索引
auto_merging_index_1 = build_automerging_index(
    documents,
    llm=OpenAI(model="gpt-3.5-turbo", temperature=0.1),
    embed_model="local:BAAI/bge-small-zh-v1.5",
    save_dir="merging_index_1",
    chunk_sizes=[2048, 512, 128],  # 三层结构的块大小设置
)
```

为这个三层结构的自动合并索引设置查询引擎。

```python
# 获取三层结构的自动合并查询引擎
auto_merging_engine_1 = get_automerging_query_engine(
    auto_merging_index_1,
    similarity_top_k=12,
    rerank_top_n=6,
)
```

同样，定义一个 TruLens 记录器，并用相同的评估问题运行评估。

```python
# 为三层结构准备TruLens记录器
tru_recorder = get_prebuilt_trulens_recorder(
    auto_merging_engine_1,
    app_id ='app_1'  # 设置应用ID
)
```

对三层结构进行评估

```python
# 对三层结构进行评估
run_evals(eval_questions, tru_recorder, auto_merging_engine_1)
```

<details class="lake-collapse"><summary id="u10c8c43a"><span class="ne-text">output：</span></summary><pre data-language="json" id="eLJJH" class="ne-codeblock language-json"><code>&gt; Merging 4 nodes into parent node.
&gt; Parent node id: 90b3476a-489a-4fee-beb7-1c5363a50ab7.
&gt; Parent node text: [16]
⼈类解决问题的模式通常是⽤最快捷、直观的判断，⽽不是有意识的、⼀步⼀步的推导，早期⼈⼯智能研究通常使⽤逐步推导的⽅式。[17]⼈⼯智能研究已经
于这种“次表征性的”解决问题⽅法获取进展...

&gt; Merging 2 nodes into parent node.
&gt; Parent node id: 7bab41fa-272e-4847-a568-e22dbc7e9fed.
&gt; Parent node text: 依⽬前的研究⽅向，电脑⽆法突变、苏醒、产⽣⾃我意志，AI也不可能具有创意与智能、同情⼼与审美等这⽅⾯的能⼒。
AI逐渐普及后，将会在企业管理中扮演很重要的⾓⾊，⽽⼈类的管理者应 如何适度的调整⾃...

&gt; Merging 5 nodes into parent node.
&gt; Parent node id: b6df9f33-521b-434b-b26d-8f6876a93184.
&gt; Parent node text: 其它关于 动物 或其它⼈造系统的智能也普遍被认为是⼈⼯智能相关的研究课题。
⼈⼯智能⽬前在 电脑 领域内，得到了愈加⼴泛的发挥。并在 机器⼈ 、经济政治决策、 控制系统 、仿真系统 中得到应⽤。...

&gt; Merging 3 nodes into parent node.
&gt; Parent node id: a7a0bda7-af15-46f6-a27f-28cf2b2357e0.
&gt; Parent node text: 2017年6⽉份马云在美国底特律举⾏“链接世界”（Gateway 17）产业⼤会，会上提出⼈⼯智能可能导致第三次世界⼤战，因为前两次产业⾰命都导致两次⼤
战，战争原因并⾮这些创新发明本⾝，⽽是发...

&gt; Merging 1 nodes into parent node.
&gt; Parent node id: 93ed48c1-a43a-4ebe-ab72-46dd57662601.
&gt; Parent node text: 这与认知科学领域中的表征
感知论点是⼀致的:更⾼的智能需要个体的表征（如移动，感知和形象）。
计算智能：1 980年代中 David Rumelhart等再次提出 神经⽹络 和联结主义[58]。</code></pre></details>
获取并显示排行榜

```python
from trulens_eval import Tru

# 获取并显示排行榜
Tru().get_leaderboard(app_ids=[])
```

运行TruLens仪表板查看详细评估结果

```python
# 运行TruLens仪表板查看详细评估结果
Tru().run_dashboard()
```

通过比较两层和三层结构的自动合并索引的 TruLens 评估结果，可以深入了解不同层次结构对检索性能的影响，并据此优化的自动合并策略。

