> 本文介绍如何私有化部署智能体开发平台Dify，并通过工作流实现调研助手智能体应用。
>
> [Docker Compose 部署 | Dify](https://docs.dify.ai/zh-hans/getting-started/install-self-hosted/docker-compose)
>
> [私有化智能体开发平台Dify工作流开发入门教程 | 手把手教你实现调研助手](https://mp.weixin.qq.com/s?__biz=MzU4NTcyMzE2NQ==&mid=2247484049&idx=1&sn=bb0f4e080a37569543afc3fde03b1971&chksm=fd877ee3caf0f7f59520bf6a5a471cb3ea34fd28c97ca990128f2fff0d419f2b3519637c02f5&scene=21#wechat_redirect)
>

# 引言
Dify是一个开源的LLM应用开发平台，旨在通过直观的界面和强大的功能，简化基于语言模型的应用开发和部署过程。Dify内置了构建LLM应用所需的关键技术栈，包括对数百个模型的支持、直观的Prompt编排界面、高质量的RAG引擎、稳健的Agent框架和灵活的流程编排，同时提供了易用的界面和API。

Dify提供了强大的工作流编排功能，允许用户在画布上构建和测试功能强大的AI工作流程。这使得开发者能够轻松地组合不同的模型和工具，实现复杂的业务逻辑。工作流通过将复杂任务分解为更小的步骤（节点），有效降低了系统的复杂度。这种方法减少了对提示词技术和模型推理能力的依赖，从而提升了 LLM 在处理复杂任务时的性能，同时增强了系统的可解释性、稳定性和容错性。

# 私有化部署Dify
## 克隆代码库
```python
git clone https://github.com/langgenius/dify.git
# 切换到0.6.16版本(本文发表时的最新release版本)
git checkout 0.6.16 
```

## 配置 docker 阿里云镜像
```python
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-EOF
{
    "registry-mirrors": [
        # 去网站获取阿里云镜像加速
        "https://xxxx.mirror.aliyuncs.com", 
        "https://dockerproxy.com",
        "https://mirror.baidubce.com",
        "https://docker.m.daocloud.io",
        "https://docker.nju.edu.cn",
        "https://docker.mirrors.sjtug.sjtu.edu.cn"
    ]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```

## 启动Dify
```python
cd dify/docker
cp .env.example .env
docker compose up -d
```

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736591585089-85f49b23-39f2-4204-82bb-517c413d7869.png)

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736591890247-ae1e29ea-6e9e-4c3e-a0d2-b71419778f1f.png)

## 服务器端口开通
[阿里云登录 - 欢迎登录阿里云，安全稳定的云计算服务平台](https://ecs.console.aliyun.com/securityGroupDetail/region/cn-hangzhou/groupId/sg-bp153nvp0hbs00ctplx9/detail/intranetIngress)

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736593213719-2e0ae41a-bea5-40be-a1f8-90407f0cae72.png)

## 设置管理员账户
访问[http://8.154.24.150/install](http://8.154.24.150/install)，在页面中输入管理员账户信息进行设置。

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736593262544-531055c1-848a-439d-96a5-c766d286d7bf.png)

## 设置LLM
点击右上角的账户信息，选择“设置”进入设置页面。

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736593531205-574095c5-90e0-491a-96ca-0314e658d45b.png)

在弹出的页面左侧，选择“模型供应商”，在右侧的列表中选择“智谱”，点击“设置”。在页面中填入API Key并保存。

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736593509808-693d3190-46a9-4542-97ee-9a1abb93b110.png)

# 创建工作流应用
## 创建应用
在`http://localhost/apps`页面点击“创建空白应用”，选择“工作流”。填写应用名，点击创建

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736593617103-7a1da548-bfb2-46e2-887c-87b231dcceaf.png)

创建后在列表页面中会展示当前已创建的应用。进入编排界面。

## 在“开始”节点添加变量
选择“开始”节点，在右边的面板点击“+”号

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736593689177-3171f5d3-0380-4b58-8218-187dd198d799.png)

在弹出的页面中，填写“变量名称”和“显示名称”，点击保存

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736593730767-63f8905c-1120-49f7-965d-00f015b395da.png)

## 添加“谷歌搜索”工具
点击“开始”节点右侧的“+”号，选择工具“谷歌搜索”。

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736594490309-b1da6cad-20f6-4055-9122-0c77c488b251.png)

选择“谷歌搜索”节点，在右侧面板点击“授权”。

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736594439382-5c9cfc1d-877d-439d-9cf5-7f8bc3a000a7.png)

在“设置授权”页面中，点击“如何获取”，按提示注册获取API Key，并填入保存。[什么是 SerpApi](https://www.yuque.com/qiaokate/su87gb/lgx1xn0x50ggntkw)

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736594507034-21225c19-7b05-4743-82ba-7b49fb5ba026.png)

将“谷歌搜索”的输入变量绑定为“开始”节点的topic变量

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920174787-b6531458-331e-43ac-b2af-be7bf7281c2a.png)

## 添加“代码执行”节点：提取URL
在“谷歌搜索”节点右侧添加“代码执行”节点

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920203037-2b815e62-6e6b-4d8e-8fee-8a93e8a7d0d5.png)

+ 输入变量名为arg，绑定“谷歌搜索”节点的输出变量json。
+ 输出变量名为urls，类型为Array[string]
+ python代码如下：

```python
def main(arg):
    urls = list()
    input = arg[0]
    for r in input["organic_results"]:
        urls.append(r["link"])
    return {
        "urls": urls
    }
```

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920276446-c4036958-133c-416f-88e5-71c25bbc421d.png)

## 添加“迭代”节点：网页爬虫
在“代码执行-提取URL”节点右侧添加“迭代”节点。

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920338100-804020f3-527c-458c-9855-5fa26cdbb74e.png)

在“迭代”节点中添加“网页爬虫”

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920374503-085ddbf2-8c97-4119-afbc-6367d5b6f9cc.png)

将“网页爬虫”节点的输入变量绑定当前迭代的item变量  
![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920406460-4f081a51-7e65-4cf5-82b5-20a1fac32022.png)

将“迭代”节点的输入变量绑定为“代码执行-提取URL”节点的输出变量urls  
![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920473784-31a59e2d-de67-4933-a1f9-6a809ba71810.png)

## 添加“模板转换”节点：数组转文本
在“迭代”节点右侧添加“模板转换”节点。（Dify的LLM节点只能处理文本，所以在LLM节点前需要把“迭代”节点的爬虫结果数组转为文本）

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920493189-9287c405-f4b9-4a4c-ae90-3cc0779ae5c0.png)

+ 输入变量名为arg，绑定“迭代”节点的输出变量output。
+ Jinja2代码如下（限制字符串长度为30000内，避免超过LLM输入token限制）：

```python
{{ arg | join("\n\n") | truncate(30000) }}
```

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920591376-1b903e69-2861-43a0-a2af-fc110c700b9d.png)

## 添加LLM节点
在“模板转换”节点右侧添加“LLM”节点

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920616142-b402444d-452b-4773-85f1-4327f89116fc.png)

+ 模型随便选择一个
+ SYSTEM消息

```plain
你是一个调研助手。目标是根据调研主题，生成一份调研报告。

# 流程
1. 根据主题和搜索结果，形成报告大纲，大纲结构合理(不用输出)
2. 对每个大纲，根据搜索结果撰写该大纲对应的章节内容(不用输出)
3. 合并各个章节的内容，对报告做润色校对。

#  报告要求
1. 结构合理、信息丰富、深入全面、主次分明
2. 字数不低于1500字
```

+ USER消息

把“开始”节点的topic变量作为主题，把“模板转换”节点的输出作为搜索结果。

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920748093-bca2d04f-c31a-4aa3-a7e9-84bcc713e10d.png)

## 添加“结束”节点
在“LLM”节点右侧添加“结束”节点。

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920777841-fdc75980-395e-4530-93f9-9be36a6efcde.png)

输出变量text绑定“LLM”节点的输出变量text

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920814911-c5022902-37f0-43f6-9542-afa3bc61280f.png)

## 测试并发布
+ 点击右上角的“运行”按钮。
+ 输入调研主题，点击“开始运行”。

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736920842462-c343d7f9-379c-4448-a6ce-b27fe3895001.png)

+ 在“追踪”Tab可以看到当前执行的节点状态

![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736921136023-e0301f7a-0b15-447d-9fce-811c1ba7a7e8.png)

+ 在“结果”Tab可以查看工作流的输出结果  
![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736921164220-c7c7ac05-1d41-4fa3-b975-1baa8049933f.png)
+ 测试通过后，点击右上角的“发布”按钮。
+ 发布后，点击“运行”即可打开应用的访问链接。  
![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736921192699-6eeb1f07-df65-451c-a2a2-5d64466c9997.png)
+ ![](https://cdn.nlark.com/yuque/0/2025/png/2639475/1736921322468-2d6d7835-edfe-41ca-8fbf-a7e89f8d8b0f.png)

